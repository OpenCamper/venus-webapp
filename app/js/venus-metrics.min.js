var Venus=function(e){var t={};function i(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)i.d(n,r,function(t){return e[t]}.bind(null,r));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=4)}([function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();t.MetricService=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.deviceInterface=t,this.metrics={},this.bindings=[]}return n(e,[{key:"start",value:function(){var e=this;this.deviceInterface.onUpdate=function(t,i){var n=e.metrics[t];void 0!==n&&(n.rawValue=i,void 0!==e.onUpdate&&e.onUpdate(n))},this.deviceInterface.onRawUpdate=function(t,i){void 0!==e.onRawUpdate&&e.onRawUpdate(t,i)},this.deviceInterface.connect()}},{key:"stop",value:function(){this.deviceInterface.disconnect()}},{key:"register",value:function(e,t,i,n,r,o){var a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"r",u=new Venus.Metric(e,i,n,r,o);return this.metrics[e]=u,void 0!==t&&this.deviceInterface.register(e,t,a),u}},{key:"unregister",value:function(e){this.metrics[e]=void 0,this.deviceInterface.unregister(e)}},{key:"bind",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"innerHTML",i=arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"value",r=this.metrics[i];if(void 0===r)throw"Binding failed. No registered metric "+i+" was found.";this.bindings.push(new Venus.DataBinding(e,t,r,n))}},{key:"unbind",value:function(e,t,i,n){this.bindings=this.bindings.filter(function(r){return r.element!==e||r.elementProperty!==t||r.metric.key!==i||r.metricProperty!==n})}},{key:"bindElements",value:function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(void 0!==i.attributes){var n=i.attributes["data-metric"],r=i.attributes["data-metric-property"],o=i.attributes["data-binding"],a="innerHTML";void 0!==o&&(a=o.nodeValue);var u="value";if(void 0!==r&&(u=r.nodeValue),void 0!==n){var s=this.metrics[n.nodeValue];void 0!==s?this.bindings.push(new Venus.DataBinding(i,a,s,u)):console.warn("Binding element failed. No registered metric "+n.nodeValue+" was found.")}}this.bindElements(i)}}},{key:"read",value:function(e){this.deviceInterface.read(e)}},{key:"write",value:function(e,t){this.deviceInterface.write(e,t)}}]),e}()},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}t.MqttInterface=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"localhost",i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:9001,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e4;r(this,e),this.host=t,this.port=i,this.timeout=n,this.isAlive=!1,this.registeredPaths={}}return n(e,[{key:"register",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"r";t.startsWith("/")||(t="/"+t);var n=i.toLowerCase();if("r"!==n&&"w"!==n&&"rw"!==n)throw"Unallowed access "+i;this.registeredPaths[t]=new o(t,e,i)}},{key:"unregister",value:function(e){var t=this.lookupKey(e);void 0!==t&&(this.registeredPaths[t.value]=void 0)}},{key:"lookupKey",value:function(e){for(var t in this.registeredPaths){var i=this.registeredPaths[t];if(void 0!==i&&i.key===e)return i}}},{key:"lookupPath",value:function(e){return this.registeredPaths[e]}},{key:"connect",value:function(){if(void 0!==this.client)throw"The mqtt interface is already connected";this.portalId=void 0,this.clientId=(new Date).toJSON().substring(2,22),this.client=new Paho.MQTT.Client(this.host,this.port,this.clientId);var e=this;e.isAliveTimerRef=setTimeout(function(){e.isAlive=!1,void 0!=e.lostConnection&&e.lostConnection()},e.timeout),this.client.onMessageArrived=function(t){try{var i=t.destinationName;if(void 0===e.portalId){if(i.startsWith("N/")&&i.endsWith("/system/0/Serial")){var n=JSON.parse(t.payloadString);for(var r in e.portalId=n.value,e.registeredPaths)e.client.send("R/"+e.portalId+r,"");e.keepAlive()}}else{e.isAlive||(e.isAlive=!0,void 0!=e.connected&&e.connected()),clearTimeout(e.isAliveTimerRef),e.isAliveTimerRef=setTimeout(function(){e.isAlive=!1,void 0!=e.lostConnection&&e.lostConnection()},e.timeout);var o=e.portalId.length+2;if(i.length>o){var a=i.substring(o),u=e.lookupPath(a),s=JSON.parse(t.payloadString);void 0!==e.onUpdate&&void 0!==u&&u.isReadable&&void 0!==s.value&&e.onUpdate(u.key,s.value),void 0!==e.onRawUpdate&&e.onRawUpdate(a,s.value)}}}catch(t){void 0!==e.onError&&e.onError(t)}},this.client.connect({onSuccess:function(t,i){e.client.subscribe("N/#")}})}},{key:"disconnect",value:function(){void 0!==this.client&&(this.client.disconnect(),this.portalId=void 0,this.client.end())}},{key:"read",value:function(e){if(void 0===this.portalId)throw"Read failed. The mqtt interface has not detected its portal id yet";var t=this.lookupKey(e);if(void 0===t)throw"Read failed. There is no path registered for key: "+e;if(!t.isReadable)throw"Read failed. The path with key "+e+" is not readable";this.client.send("R/"+this.portalId+t.value,"")}},{key:"write",value:function(e,t){if(void 0===this.portalId)throw"Write failed. The mqtt interface has not detected its portal id yet";var i=this.lookupKey(e);if(void 0===i)throw"Write failed. There is no path registered for key: "+e;if(!i.isWritable)throw"Write failed. The path with key "+e+" is not writable";var n=JSON.stringify({value:t});this.client.send("W/"+this.portalId+i.value,n)}},{key:"keepAlive",value:function(){void 0!==this.portalId&&this.client.send("R/"+this.portalId+"/system/0/Serial","")}}]),e}();var o=t.MqttInterfacePath=function e(t,i,n){r(this,e),this.value=t,this.key=i,this.isReadable=n.toLowerCase().includes("r"),this.isWritable=n.toLowerCase().includes("w")}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();t.DataBinding=function(){function e(t,i,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.element=t,this.elementProperty=i,this.metric=n,this.metricProperty=r,this.update();var o=this;this.metric.addOnChangeCallback(function(e){o.update()})}return n(e,[{key:"update",value:function(){this.element[this.elementProperty]=this.metric[this.metricProperty]}}]),e}()},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();t.defaultFormatter=r,t.numericFormatter=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"--";return function(n){if(void 0===n.rawValue||null===n.rawValue)return i+n.unit;var r=Number(n.rawValue)*t;return void 0===e?r.toString()+n.unit:r.toFixed(e)+n.unit}};t.Metric=function(){function e(t,i,n,o,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.key=t,this.description=i,this.unit=n,this.formatter=void 0===o?r():o,this.timeout=void 0===a?0:a,this._rawValue=void 0,this.callbacks=[],this.timerReference=void 0}return n(e,[{key:"toStale",value:function(e){var t=document.getElementById(e);void 0!=t&&null!=t&&(t.innerHTML='<span class="staleValues">'+t.innerHTML+"</span>")}},{key:"addOnChangeCallback",value:function(e){this.callbacks.push(e)}},{key:"value",get:function(){return"<span id="+this.key+">"+this.formatter(this)+"</a>"}},{key:"rawValue",get:function(){return this._rawValue},set:function(e){var t=this;this._rawValue=e,this.timeout>0&&(clearTimeout(this.timerReference),this.timerReference=setTimeout(this.toStale.bind(this,this.key),this.timeout)),this.callbacks.forEach(function(e){e(t)})}}]),e}();function r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"--";return function(t){return void 0===t.rawValue||null===t.rawValue?e+t.unit:t.rawValue.toString()+t.unit}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=i(3);Object.keys(n).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return n[e]}})});var r=i(2);Object.keys(r).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return r[e]}})});var o=i(1);Object.keys(o).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}})});var a=i(0);Object.keys(a).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}})});i(3),u(i(2)),u(i(1)),u(i(0));function u(e){return e&&e.__esModule?e:{default:e}}}]);
//# sourceMappingURL=venus-metrics.min.js.map